define(["require","exports","jquery","common","commands"],function(F,l,f,h,k){var q=function(){function e(e,f,h,k,l,q,p){this._resourcePath=e;this._projectPath=f;this._projectDirectory=h;this._filePath=k;this._fileName=l;this._fileDirectory=q;this._originalPath=p}e.prototype.getResourcePath=function(){return this._resourcePath};e.prototype.getProjectPath=function(){return this._projectPath};e.prototype.getProjectDirectory=function(){return this._projectDirectory};e.prototype.getFilePath=function(){return this._filePath};
e.prototype.getFileName=function(){return this._fileName};e.prototype.getFileDirectory=function(){return this._fileDirectory};e.prototype.getOriginalPath=function(){return this._originalPath};return e}();l.FilePath=q;var v=function(){function e(e,f){this._resourcePath=e;this._children=f}e.prototype.getResource=function(){return this._resourcePath};e.prototype.getChildren=function(){return this._children};e.prototype.isFolder=function(){return 0<this._children.length};return e}();l.FileNode=v;(function(e){function l(a,
c,d,b,n,r,y,e){f(document).ready(function(){h.Common.getProjectName();var g="/tree"+a+"?id\x3d"+d+"\x26folders\x3d"+n+"\x26depth\x3d"+e;null!=b&&(g+="\x26expand\x3d"+b);f.ajax({url:g,success:function(a){f("#"+c).html(a);A(d,!n,r,y)},async:!0})})}function w(a,c){var d=document.getElementById("browseParent"),b=f("#"+a).fancytree("getTree");b&&"function"===typeof b.getNodeByKey&&(b=b.getNodeByKey(c))&&(b.li&&d&&!h.Common.isChildElementVisible(d,b.li)&&(d.scrollTop=0,d.scrollTop=h.Common.calculateScrollOffset(d,
b.li)),b.setActive())}function A(a,c,d,b){f("#"+a).fancytree({click:b,expand:function(c,b){"undefined"!==typeof k.Command&&(k.Command.folderExpand(b.node.key),setTimeout(function(){p(a,d);u(a)},10))},collapse:function(c,b){"undefined"!==typeof k.Command&&(k.Command.folderCollapse(b.node.key),setTimeout(function(){p(a,d);u(a)},10))},init:function(c,b,y){p(a,d);u(a)}})}function u(a){var c=document.getElementById(a),d=h.Common.getElementsByClassName(c,"fancytree-folder");a=function(){var a=d[b];f(a).on("dragenter",
function(c){f(a).find(".fancytree-title").addClass("treeFolderDragOver")}).on("dragleave",function(c){f(a).find(".fancytree-title").removeClass("treeFolderDragOver")}).on("drop",function(b){var d=f(a).find(".fancytree-title"),e=(b.target.dataTransfer||b.originalEvent.dataTransfer).getData("resource"),n=f(d).attr("title");f(d).removeClass("treeFolderDragOver");b.stopPropagation();b.preventDefault();d=t(n);n=x(c,d);d=new v(d,n);e?(b=JSON.parse(e),b=t(b.resource),e=x(c,b),b=new v(b,e),k.Command.dragAndDropFile(b,
d)):C(b,d)}).on("dragover",function(a){a.preventDefault()});B(c)};for(var b=0;b<d.length;b++)a()}function x(a,c){var d=c.getResourcePath(),b=f(a).fancytree("getTree").findAll(function(a){return a.key!=d?h.Common.stringStartsWith(a.key,d):!1});if(b&&0<b.length){for(var e=[],r=0;r<b.length;r++)e.push(b[r].key);return e}return[]}function B(a){var c=h.Common.getElementsByClassName(a,"fancytree-node");a=function(){var a=c[d];a&&(a.setAttribute("draggable","true"),f(a).on("dragstart",function(b){var c=
b.target.dataTransfer||b.originalEvent.dataTransfer;b=b.target||b.currentTarger;var d=h.Common.getElementsByClassName(a,"fancytree-title");d&&0<d.length&&c.setData("resource",JSON.stringify({resource:d[0].getAttribute("title"),folder:D(b)}))}))};for(var d=0;d<c.length;d++)a()}function p(a,c){null!=c&&f("#"+a).contextmenu({delegate:"span.fancytree-title",menu:[{title:"\x26nbsp;New",uiIcon:"menu-new",children:[{title:"\x26nbsp;File",cmd:"newFile",uiIcon:"menu-new"},{title:"\x26nbsp;Directory",cmd:"newDirectory",
uiIcon:"menu-new"}]},{title:"\x26nbsp;Save",cmd:"saveFile",uiIcon:"menu-save"},{title:"\x26nbsp;Rename",cmd:"renameFile",uiIcon:"menu-rename"},{title:"\x26nbsp;Delete",cmd:"deleteFile",uiIcon:"menu-trash",disabled:!1},{title:"\x26nbsp;Run",cmd:"runScript",uiIcon:"menu-run"},{title:"\x26nbsp;Debug",cmd:"debugScript",uiIcon:"menu-debug"},{title:"\x26nbsp;Export",cmd:"createArchive",uiIcon:"menu-archive"},{title:"\x26nbsp;Explore",cmd:"exploreDirectory",uiIcon:"menu-explore"},{title:"\x26nbsp;Terminal",
cmd:"openTerminal",uiIcon:"menu-terminal"}],beforeOpen:function(a,b){f.ui.fancytree.getNode(b.target).setActive();b.menu.zIndex(f(a.target).zIndex()+2E3)},select:function(a,b){var d=f.ui.fancytree.getNode(b.target);if(d){var e=t(d.tooltip);c(e,b.cmd,b.key,d.isFolder())}}})}function C(a,c){var d=a.target.files||a.originalEvent.dataTransfer.files||a.dataTransfer.files;if(d)for(var b=0;b<d.length;b++){var e=d[b];if(E()){console.log("file\x3d"+e.name+" folder\x3d"+c);var f=new FileReader;f.onload=function(a){var b;
b="";a=new Uint8Array(a.target.result);for(var d=a.byteLength,f=0;f<d;f++)b+=String.fromCharCode(a[f]);b=window.btoa(b);k.Command.uploadFileTo(e.name,c,b)};f.readAsArrayBuffer(e)}}}function D(a){return(a=f(a).filter(".fancytree-folder"))?0<a.length:!1}function E(){var a=document.createElement("div");return("draggable"in a||"ondragstart"in a&&"ondrop"in a)&&"FormData"in window&&"FileReader"in window}function z(a){if(!h.Common.stringEndsWith(a,"/")){var c=a.split(".");return 1===a.length||""===c[0]&&
2===c.length?!0:0<=c.pop().indexOf("/")}return!0}function m(a){if(null!=a){for(a=a.replace(/\/+/,"/").replace(/\.#/,"");-1!=a.indexOf("//");)a=a.replace("//","/");h.Common.stringEndsWith(a,"/")&&(a=a.substring(0,a.length-1));return a}return null}function t(a){for(var c="/resource/"+h.Common.getProjectName()+"/",d="/resource/"+h.Common.getProjectName();-1!=a.indexOf("//");)a=a.replace("//","/");if(a==d||a==c)return new q(m(c),"/","/","/",null,"/",a);0!=a.indexOf("/")&&(a="/"+a);0!=a.indexOf(c)&&(a=
"/resource/"+h.Common.getProjectName()+a);for(var b=z(a),c=a.split("/"),d="/resource/"+h.Common.getProjectName(),e="",f="",l="",k="",g=3;g<c.length;g++)d+="/"+c[g],e+="/"+c[g],l+="/"+c[g];if(b)if(b=c[c.length-1],3<c.length)for(g=3;g<c.length;g++)f+="/"+c[g],k+="/"+c[g];else k="/";else if(b=c[c.length-1],4<c.length)for(g=3;g<c.length-1;g++)f+="/"+c[g],k+="/"+c[g];else k="/";return new q(m(d),m(e),m(""==f?"/":f),m(l),m(b),m(k),a)}e.createTree=function(a,c,d,b,e,f,h){l(a,c,d,b,e,f,h,1E4)};e.createTreeOfDepth=
l;e.showTreeNode=function(a,c){a&&c&&c.getResourcePath()&&(w(a,c.getResourcePath()),w(a,c.getResourcePath()))};e.isResourceFolder=z;e.cleanResourcePath=m;e.createResourcePath=t})(l.FileTree||(l.FileTree={}))});
