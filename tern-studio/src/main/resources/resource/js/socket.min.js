define(["require","exports","spinner"],function(t,k,m){(function(l){function k(){e=new WebSocket(g.address);e.onopen=function(){p=1;r++;m.LoadSpinner.hide();console.log("Socket connected to '"+g.address+"'")};e.onerror=function(a){a=h.length;for(var b=0;b<a;b++){var c=h[b];null!=c&&c()}m.LoadSpinner.show();console.log("Error connecting to '"+g.address+"'")};e.onclose=function(a){a=1E3*(Math.pow(2,p++)-1);var b=h.length,c=k();3E4<a&&(a=3E4);setTimeout(c,a);for(c=0;c<b;c++){var d=h[c];null!=d&&d()}m.LoadSpinner.show();
console.log("Connection closed to '"+g.address+"' reconnecting in "+a+" ms")};e.onmessage=function(a){var b=a.data,c=b.indexOf(":");a=null;-1!=c&&(a=b.substring(c+1),b=b.substring(0,c));c=n[b];if(void 0!=c){if(!g.panic)for(var d=0;d<c.length;d++){var e=c[d];null!=e&&e(this,b,a)}}else console.log("No route defined for '"+b+"' with '"+a+"'");m.LoadSpinner.hide()}}function q(a){if(null!=a){for(var b=h.length,c=!1,d=0;d<b;d++)h[d]==a&&(c=!0);c||h.push(a)}}var g={},n={},h=[],e=null,r=0,p=0;l.startSocket=
function(){var a=window.document.location.hostname,b=window.document.location.port,c=window.document.location.protocol,d=window.document.location.pathname,e=window.document.location.search;g.panic=!1;g.query=e;var f="ws://";0==c.indexOf("https")&&(f="wss://");f+=a;0<=b-parseFloat(b)+1&&(f=f+":"+b);a=d.split("/");f=2<a.length?f+("/connect/"+a[2]):f+"/connect";g.address=f+e;k()};l.isSocketOpen=function(){return e?1==e.readyState:!1};l.sendEvent=function(a,b){if(b){var c=JSON.stringify(b);e&&e.send(a+
":"+c)}else e.send(a)};l.createRoute=function(a,b,c){var d=a.toUpperCase();d!=a&&alert("Illegal route '"+d+"' is not in upper case");d=n[a];null==d&&(d=[],n[a]=d);if(null!=b){a=d.length;for(var g=!1,f=0;f<a;f++)d[f]==b&&(g=!0);g||d.push(b)}q(c);e&&e.close()};l.createTermination=q})(k.EventBus||(k.EventBus={}))});
