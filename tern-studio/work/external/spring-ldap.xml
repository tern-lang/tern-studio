<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:aop="http://www.springframework.org/schema/aop"
  xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd">

  <bean id="DirectoryService" class="org.apache.directory.server.core.DefaultDirectoryService" />

  <bean id="DirectoryStructure" class="com.zuooh.ldap.directory.service.DirectoryStructure">
    <constructor-arg>
      <map>
        <entry key="${directory.partition}" value="${directory.root}" />
      </map>
    </constructor-arg>
  </bean>

  <bean id="DirectoryServiceController" class="com.zuooh.ldap.directory.service.DirectoryServiceController" init-method="start">
    <constructor-arg ref="DirectoryService" />
    <constructor-arg ref="DirectoryStructure" />
    <constructor-arg value="${directory.path}" />
    <constructor-arg value="${directory.port}" />
  </bean>

  <bean id="DirectoryProperties" class="java.util.HashMap">
    <constructor-arg>
      <map>
        <entry key="java.naming.factory.initial" value="com.sun.jndi.ldap.LdapCtxFactory" />
        <entry key="java.naming.provider.url" value="ldap://localhost:${directory.port}" />
        <entry key="java.naming.referral" value="follow" />
        <entry key="com.sun.jndi.ldap.connect.timeout" value="5000" />
      </map>
    </constructor-arg>
  </bean>

  <bean id="DirectoryContext" class="com.zuooh.ldap.DirectoryContext">
    <qualifier value="external" />
    <constructor-arg ref="DirectoryProperties" />
    <constructor-arg value="DC=zuooh,DC=com" />
    <constructor-arg value=".*ou=Deleted,dc=zuooh,dc=com" />
    <constructor-arg value="10000" />
  </bean>

  <bean id="GroupMapper" class="com.zuooh.ldap.record.TokenMapper">
    <constructor-arg>
      <map>
        <entry key="dn" value="STRING" />
        <entry key="cn" value="STRING" />
        <entry key="owner" value="STRING" />
        <entry key="uniqueMember" value="LIST" />
        <entry key="ou" value="LIST" />
        <entry key="description" value="STRING" />
        <entry key="owner" value="STRING" />
      </map>
    </constructor-arg>
    <constructor-arg>
      <map>
        <entry key="dn" value="location" />
        <entry key="cn" value="name" />
        <entry key="owner" value="owner" />
        <entry key="uniqueMember" value="members" />
        <entry key="ou" value="qualifiers" />
        <entry key="description" value="description" />
        <entry key="owner" value="owner" />
      </map>
    </constructor-arg>
  </bean>

  <bean id="GroupFilter" class="com.zuooh.ldap.record.TokenFilter">
    <constructor-arg>
      <list>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="LIST" />
          <constructor-arg value="objectClass" />
          <constructor-arg value="top" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="LIST" />
          <constructor-arg value="objectClass" />
          <constructor-arg value="groupOfUniqueNames" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="LIST" />
          <constructor-arg value="ou" />
          <constructor-arg value="group" />
        </bean>        
      </list>
    </constructor-arg>
  </bean>

  <bean id="GroupConverter" class="com.zuooh.ldap.record.TokenConverter">
    <constructor-arg ref="GroupMapper" />
    <constructor-arg ref="GroupFilter" />
    <constructor-arg value="com.zuooh.ldap.model.Group" />
  </bean>

  <bean id="GroupBuilder" class="com.zuooh.ldap.record.TemplateBuilder">
    <constructor-arg>
      <list>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="STRING" />
          <constructor-arg value="cn" />
          <constructor-arg value="%{group}" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="STRING" />
          <constructor-arg value="original" />
          <constructor-arg value="%{original}" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="STRING" />
          <constructor-arg value="description" />
          <constructor-arg value="%{description}" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="STRING" />
          <constructor-arg value="owner" />
          <constructor-arg value="%{owner}" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="LIST" />
          <constructor-arg value="ou" />
          <constructor-arg value="%{type}" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="LIST" />
          <constructor-arg value="uniqueMember" />
          <constructor-arg value="%{member}" />
        </bean>
      </list>
    </constructor-arg>
    <constructor-arg>
      <list>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="LIST" />
          <constructor-arg value="objectClass" />
          <constructor-arg value="top" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="LIST" />
          <constructor-arg value="objectClass" />
          <constructor-arg value="groupOfUniqueNames" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="LIST" />
          <constructor-arg value="ou" />
          <constructor-arg value="group" />
        </bean>        
      </list>
    </constructor-arg>
    <constructor-arg value="cn=%{group},ou=Groups,dc=zuooh,dc=com" />
  </bean>

  <bean id="GroupAttributeValidator" class="com.zuooh.ldap.record.validate.TokenRecordValidator">
    <constructor-arg>
      <list>
        <bean class="com.zuooh.ldap.record.validate.TokenValidator">
          <constructor-arg value="cn" />
          <constructor-arg value=".*[a-zA-Z]+.*" />
          <constructor-arg value="Group name '%{cn}' is not valid" />
          <constructor-arg value="Group must have a name" />
        </bean>
        <bean class="com.zuooh.ldap.record.validate.TokenValidator">
          <constructor-arg value="uniqueMember" />
          <constructor-arg value="cn=(.*),ou=Groups,dc=zuooh,dc=com" />
          <constructor-arg value="Group member '%{uniqueMember}' is not valid" />
        </bean>
        <bean class="com.zuooh.ldap.record.validate.TokenValidator">
          <constructor-arg value="ou" />
          <constructor-arg value=".*[a-zA-Z]+.*" />
          <constructor-arg value="Group qualifier '%{qualifier}' is not valid" />
          <constructor-arg value="Group must have a valid qualifier" />
        </bean>
        <bean class="com.zuooh.ldap.record.validate.TokenValidator">
          <constructor-arg value="description" />
          <constructor-arg value=".*[a-zA-Z]+.*" />
          <constructor-arg value="Group description '%{description}' is not valid" />
          <constructor-arg value="Group must have a valid description" />
        </bean>
        <bean class="com.zuooh.ldap.record.validate.TokenValidator">
          <constructor-arg value="owner" />
          <constructor-arg value="o=(.*),ou=Companies,dc=zuooh,dc=com" />
          <constructor-arg value="Group owner '%{owner}' is not valid" />
        </bean>
      </list>
    </constructor-arg>
  </bean>

  <bean id="GroupLocationValidator" class="com.zuooh.ldap.record.validate.LocationRecordValidator">
    <constructor-arg value="cn=(.*),ou=Groups,dc=zuooh,dc=com" />
    <constructor-arg value="Group location did not match 'cn=(.*),ou=Groups,dc=zuooh,dc=com'" />
  </bean>

  <bean id="GroupMemberValidator" class="com.zuooh.ldap.record.validate.ReferenceRecordValidator">
    <constructor-arg ref="Directory" />
    <constructor-arg value="member" />
    <constructor-arg value="Group references member '%{member}' which could not be found" />
  </bean>

  <bean id="GroupOwnerValidator" class="com.zuooh.ldap.record.validate.ReferenceRecordValidator">
    <constructor-arg ref="Directory" />
    <constructor-arg value="owner" />
    <constructor-arg value="Group references owner '%{owner}' which could not be found" />
  </bean>

  <bean id="GroupValidator" class="com.zuooh.ldap.record.validate.CombinationRecordValidator">
    <constructor-arg>
      <list>
        <ref bean="GroupAttributeValidator" />
        <ref bean="GroupLocationValidator" />
        <ref bean="GroupOwnerValidator" />
        <ref bean="GroupMemberValidator" />
      </list>
    </constructor-arg>
  </bean>

  <bean id="GroupDeletePersister" class="com.zuooh.ldap.model.persist.GroupDeletePersister">
    <constructor-arg ref="Directory" />
    <constructor-arg ref="ModelContainer" />
    <constructor-arg ref="LocationManager" />
  </bean>

  <bean id="GroupInsertPersister" class="com.zuooh.ldap.model.persist.GroupInsertPersister">
    <constructor-arg ref="Directory" />
    <constructor-arg ref="ModelContainer" />
    <constructor-arg ref="RecordBinder" />
  </bean>

  <bean id="GroupUpdatePersister" class="com.zuooh.ldap.model.persist.GroupUpdatePersister">
    <constructor-arg ref="Directory" />
    <constructor-arg ref="ModelContainer" />
    <constructor-arg ref="RecordBinder" />
    <constructor-arg value="original" />
  </bean>

  <bean id="GroupPersister" class="com.zuooh.ldap.record.persist.RecordPersister">
    <qualifier value="group" />
    <constructor-arg>
      <bean class="com.zuooh.ldap.record.persist.InsertRecordOperation">
        <constructor-arg ref="GroupInsertPersister" />
        <constructor-arg ref="GroupBuilder" />
        <constructor-arg ref="GroupValidator" />
        <constructor-arg value="Could not insert group" />
      </bean>
    </constructor-arg>
    <constructor-arg>
      <bean class="com.zuooh.ldap.record.persist.UpdateRecordOperation">
        <constructor-arg ref="GroupUpdatePersister" />
        <constructor-arg ref="GroupBuilder" />
        <constructor-arg ref="GroupValidator" />
        <constructor-arg value="Could not update group" />
      </bean>
    </constructor-arg>
    <constructor-arg>
      <bean class="com.zuooh.ldap.record.persist.DeleteRecordOperation">
        <constructor-arg ref="GroupDeletePersister" />
        <constructor-arg ref="GroupBuilder" />
        <constructor-arg value="Could not delete group" />
      </bean>
    </constructor-arg>
  </bean>

  <bean id="PersonListMapper" class="com.zuooh.ldap.record.TokenMapper">
    <constructor-arg>
      <map>
        <entry key="dn" value="STRING" />
        <entry key="cn" value="STRING" />
        <entry key="owner" value="STRING" />
        <entry key="uniqueMember" value="LIST" />
        <entry key="ou" value="LIST" />
        <entry key="description" value="STRING" />
        <entry key="owner" value="STRING" />
      </map>
    </constructor-arg>
    <constructor-arg>
      <map>
        <entry key="dn" value="location" />
        <entry key="cn" value="name" />
        <entry key="owner" value="owner" />
        <entry key="uniqueMember" value="members" />
        <entry key="ou" value="qualifiers" />
        <entry key="description" value="description" />
        <entry key="owner" value="owner" />
      </map>
    </constructor-arg>
  </bean>

  <bean id="PersonListFilter" class="com.zuooh.ldap.record.TokenFilter">
    <constructor-arg>
      <list>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="LIST" />
          <constructor-arg value="objectClass" />
          <constructor-arg value="top" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="LIST" />
          <constructor-arg value="objectClass" />
          <constructor-arg value="groupOfUniqueNames" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="LIST" />
          <constructor-arg value="ou" />
          <constructor-arg value="list" />
        </bean>
      </list>
    </constructor-arg>
  </bean>

  <bean id="PersonListConverter" class="com.zuooh.ldap.record.TokenConverter">
    <constructor-arg ref="PersonListMapper" />
    <constructor-arg ref="PersonListFilter" />
    <constructor-arg value="com.zuooh.ldap.model.PersonList" />
  </bean>

  <bean id="PersonListBuilder" class="com.zuooh.ldap.record.TemplateBuilder">
    <constructor-arg>
      <list>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="STRING" />
          <constructor-arg value="cn" />
          <constructor-arg value="%{list}" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="STRING" />
          <constructor-arg value="original" />
          <constructor-arg value="%{original}" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="STRING" />
          <constructor-arg value="description" />
          <constructor-arg value="%{description}" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="STRING" />
          <constructor-arg value="owner" />
          <constructor-arg value="%{owner}" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="LIST" />
          <constructor-arg value="ou" />
          <constructor-arg value="%{type}" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="LIST" />
          <constructor-arg value="uniqueMember" />
          <constructor-arg value="%{member}" />
        </bean>
      </list>
    </constructor-arg>
    <constructor-arg>
      <list>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="LIST" />
          <constructor-arg value="objectClass" />
          <constructor-arg value="top" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="LIST" />
          <constructor-arg value="objectClass" />
          <constructor-arg value="groupOfUniqueNames" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="LIST" />
          <constructor-arg value="ou" />
          <constructor-arg value="list" />
        </bean>
      </list>
    </constructor-arg>
    <constructor-arg value="cn=%{list},ou=Groups,dc=zuooh,dc=com" />
  </bean>

  <bean id="PersonListAttributeValidator" class="com.zuooh.ldap.record.validate.TokenRecordValidator">
    <constructor-arg>
      <list>
        <bean class="com.zuooh.ldap.record.validate.TokenValidator">
          <constructor-arg value="cn" />
          <constructor-arg value=".*[a-zA-Z]+.*" />
          <constructor-arg value="List name '%{cn}' is not valid" />
          <constructor-arg value="List must have a name" />
        </bean>
        <bean class="com.zuooh.ldap.record.validate.TokenValidator">
          <constructor-arg value="ou" />
          <constructor-arg value=".*[a-zA-Z]+.*" />
          <constructor-arg value="List qualifier '%{qualifier}' is not valid" />
          <constructor-arg value="List must have a valid qualifier" />
        </bean>
        <bean class="com.zuooh.ldap.record.validate.TokenValidator">
          <constructor-arg value="uniqueMember" />
          <constructor-arg value="mail=(.*),ou=Users,dc=zuooh,dc=com" />
          <constructor-arg value="List member '%{uniqueMember}' is not valid" />
        </bean>
        <bean class="com.zuooh.ldap.record.validate.TokenValidator">
          <constructor-arg value="description" />
          <constructor-arg value=".*[a-zA-Z]+.*" />
          <constructor-arg value="List description '%{description}' is not valid" />
          <constructor-arg value="List must have a valid description" />
        </bean>
        <bean class="com.zuooh.ldap.record.validate.TokenValidator">
          <constructor-arg value="owner" />
          <constructor-arg value="o=(.*),ou=Companies,dc=zuooh,dc=com" />
          <constructor-arg value="List owner '%{owner}' is not valid" />
        </bean>
      </list>
    </constructor-arg>
  </bean>

  <bean id="PersonListLocationValidator" class="com.zuooh.ldap.record.validate.LocationRecordValidator">
    <constructor-arg value="cn=(.*),ou=Groups,dc=zuooh,dc=com" />
    <constructor-arg value="List location did not match 'cn=(.*),ou=Groups,dc=zuooh,dc=com'" />
  </bean>

  <bean id="PersonListMemberValidator" class="com.zuooh.ldap.record.validate.ReferenceRecordValidator">
    <constructor-arg ref="Directory" />
    <constructor-arg value="member" />
    <constructor-arg value="List references member '%{member}' which could not be found" />
  </bean>

  <bean id="PersonListOwnerValidator" class="com.zuooh.ldap.record.validate.ReferenceRecordValidator">
    <constructor-arg ref="Directory" />
    <constructor-arg value="owner" />
    <constructor-arg value="List references owner '%{owner}' which could not be found" />
  </bean>

  <bean id="PersonListValidator" class="com.zuooh.ldap.record.validate.CombinationRecordValidator">
    <constructor-arg>
      <list>
        <ref bean="PersonListAttributeValidator" />
        <ref bean="PersonListLocationValidator" />
        <ref bean="PersonListOwnerValidator" />
        <ref bean="PersonListMemberValidator" />
      </list>
    </constructor-arg>
  </bean>

  <bean id="PersonListDeletePersister" class="com.zuooh.ldap.model.persist.GroupDeletePersister">
    <constructor-arg ref="Directory" />
    <constructor-arg ref="ModelContainer" />
    <constructor-arg ref="LocationManager" />
  </bean>

  <bean id="PersonListInsertPersister" class="com.zuooh.ldap.model.persist.GroupInsertPersister">
    <constructor-arg ref="Directory" />
    <constructor-arg ref="ModelContainer" />
    <constructor-arg ref="RecordBinder" />
  </bean>

  <bean id="PersonListUpdatePersister" class="com.zuooh.ldap.model.persist.GroupUpdatePersister">
    <constructor-arg ref="Directory" />
    <constructor-arg ref="ModelContainer" />
    <constructor-arg ref="RecordBinder" />
    <constructor-arg value="original" />
  </bean>

  <bean id="PersonListPersister" class="com.zuooh.ldap.record.persist.RecordPersister">
    <qualifier value="list" />
    <constructor-arg>
      <bean class="com.zuooh.ldap.record.persist.InsertRecordOperation">
        <constructor-arg ref="PersonListInsertPersister" />
        <constructor-arg ref="PersonListBuilder" />
        <constructor-arg ref="PersonListValidator" />
        <constructor-arg value="Could not insert list" />
      </bean>
    </constructor-arg>
    <constructor-arg>
      <bean class="com.zuooh.ldap.record.persist.UpdateRecordOperation">
        <constructor-arg ref="PersonListUpdatePersister" />
        <constructor-arg ref="PersonListBuilder" />
        <constructor-arg ref="PersonListValidator" />
        <constructor-arg value="Could not update list" />
      </bean>
    </constructor-arg>
    <constructor-arg>
      <bean class="com.zuooh.ldap.record.persist.DeleteRecordOperation">
        <constructor-arg ref="PersonListDeletePersister" />
        <constructor-arg ref="PersonListBuilder" />
        <constructor-arg value="Could not delete list" />
      </bean>
    </constructor-arg>
  </bean>

  <bean id="CompanyMapper" class="com.zuooh.ldap.record.TokenMapper">
    <constructor-arg>
      <map>
        <entry key="dn" value="STRING" />
        <entry key="o" value="STRING" />
        <entry key="physicalDeliveryOfficeName" value="STRING" />
        <entry key="description" value="STRING" />
      </map>
    </constructor-arg>
    <constructor-arg>
      <map>
        <entry key="dn" value="location" />
        <entry key="o" value="code" />
        <entry key="physicalDeliveryOfficeName" value="name" />
        <entry key="description" value="description" />
      </map>
    </constructor-arg>
  </bean>

  <bean id="CompanyFilter" class="com.zuooh.ldap.record.TokenFilter">
    <constructor-arg>
      <list>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="LIST" />
          <constructor-arg value="objectClass" />
          <constructor-arg value="top" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="LIST" />
          <constructor-arg value="objectClass" />
          <constructor-arg value="organization" />
        </bean>
      </list>
    </constructor-arg>
  </bean>

  <bean id="CompanyConverter" class="com.zuooh.ldap.record.TokenConverter">
    <constructor-arg ref="CompanyMapper" />
    <constructor-arg ref="CompanyFilter" />
    <constructor-arg value="com.zuooh.ldap.model.Company" />
  </bean>

  <bean id="CompanyBuilder" class="com.zuooh.ldap.record.TemplateBuilder">
    <constructor-arg>
      <list>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="STRING" />
          <constructor-arg value="o" />
          <constructor-arg value="%{company}" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="STRING" />
          <constructor-arg value="original" />
          <constructor-arg value="%{original}" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="STRING" />
          <constructor-arg value="physicalDeliveryOfficeName" />
          <constructor-arg value="%{name}" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="STRING" />
          <constructor-arg value="description" />
          <constructor-arg value="%{description}" />
        </bean>
      </list>
    </constructor-arg>
    <constructor-arg>
      <list>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="LIST" />
          <constructor-arg value="objectClass" />
          <constructor-arg value="top" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="LIST" />
          <constructor-arg value="objectClass" />
          <constructor-arg value="organization" />
        </bean>
      </list>
    </constructor-arg>
    <constructor-arg value="o=%{company},ou=Companies,dc=zuooh,dc=com" />
  </bean>

  <bean id="CompanyAttributeValidator" class="com.zuooh.ldap.record.validate.TokenRecordValidator">
    <constructor-arg>
      <list>
        <bean class="com.zuooh.ldap.record.validate.TokenValidator">
          <constructor-arg value="o" />
          <constructor-arg value="[a-zA-Z0-9]+" />
          <constructor-arg value="Company code %{o} is not valid" />
          <constructor-arg value="Company must have a code" />
        </bean>
        <bean class="com.zuooh.ldap.record.validate.TokenValidator">
          <constructor-arg value="physicalDeliveryOfficeName" />
          <constructor-arg value=".*[a-zA-Z]+.*" />
          <constructor-arg value="Company full name %{physicalDeliveryOfficeName} is not valid" />
          <constructor-arg value="Company must have a valid full name" />
        </bean>
        <bean class="com.zuooh.ldap.record.validate.TokenValidator">
          <constructor-arg value="description" />
          <constructor-arg value=".*[a-zA-Z]+.*" />
          <constructor-arg value="Company description %{description} is not valid" />
          <constructor-arg value="Company must have a valid description" />
        </bean>
      </list>
    </constructor-arg>
  </bean>

  <bean id="CompanyLocationValidator" class="com.zuooh.ldap.record.validate.LocationRecordValidator">
    <constructor-arg value="o=(.*),ou=Companies,dc=zuooh,dc=com" />
    <constructor-arg value="Company location did not match 'o=(.*),ou=Companies,dc=zuooh,dc=com'" />
  </bean>

  <bean id="CompanyValidator" class="com.zuooh.ldap.record.validate.CombinationRecordValidator">
    <constructor-arg>
      <list>
        <ref bean="CompanyAttributeValidator" />
        <ref bean="CompanyLocationValidator" />
      </list>
    </constructor-arg>
  </bean>

  <bean id="CompanyDeletePersister" class="com.zuooh.ldap.model.persist.CompanyDeletePersister">
    <constructor-arg ref="Directory" />
    <constructor-arg ref="ModelContainer" />
    <constructor-arg ref="LocationManager" />
  </bean>

  <bean id="CompanyInsertPersister" class="com.zuooh.ldap.model.persist.CompanyInsertPersister">
    <constructor-arg ref="Directory" />
    <constructor-arg ref="ModelContainer" />
    <constructor-arg ref="RecordBinder" />
  </bean>

  <bean id="CompanyUpdatePersister" class="com.zuooh.ldap.model.persist.CompanyUpdatePersister">
    <constructor-arg ref="Directory" />
    <constructor-arg ref="ModelContainer" />
    <constructor-arg ref="RecordBinder" />
    <constructor-arg value="original" />
  </bean>

  <bean id="CompanyPersister" class="com.zuooh.ldap.record.persist.RecordPersister">
    <qualifier value="company" />
    <constructor-arg>
      <bean class="com.zuooh.ldap.record.persist.InsertRecordOperation">
        <constructor-arg ref="CompanyInsertPersister" />
        <constructor-arg ref="CompanyBuilder" />
        <constructor-arg ref="CompanyValidator" />
        <constructor-arg value="Could not insert company" />
      </bean>
    </constructor-arg>
    <constructor-arg>
      <bean class="com.zuooh.ldap.record.persist.UpdateRecordOperation">
        <constructor-arg ref="CompanyUpdatePersister" />
        <constructor-arg ref="CompanyBuilder" />
        <constructor-arg ref="CompanyValidator" />
        <constructor-arg value="Could not update company" />
      </bean>
    </constructor-arg>
    <constructor-arg>
      <bean class="com.zuooh.ldap.record.persist.DeleteRecordOperation">
        <constructor-arg ref="CompanyDeletePersister" />
        <constructor-arg ref="CompanyBuilder" />
        <constructor-arg value="Could not delete company" />
      </bean>
    </constructor-arg>
  </bean>

  <bean id="PersonMapper" class="com.zuooh.ldap.record.TokenMapper">
    <constructor-arg>
      <map>
        <entry key="dn" value="STRING" />
        <entry key="displayName" value="STRING" />
        <entry key="o" value="STRING" />
        <entry key="cn" value="STRING" />
        <entry key="uid" value="STRING" />
        <entry key="status" value="STRING" />
        <entry key="mail" value="STRING" />
        <entry key="description" value="STRING" />
        <entry key="sn" value="STRING" />
        <entry key="givenName" value="STRING" />
        <entry key="telephoneNumber" value="STRING" />
        <entry key="jpegPhoto" value="BINARY" />
        <entry key="mobile" value="STRING" />
        <entry key="jobTitle" value="STRING" />
        <entry key="department" value="STRING" />
        <entry key="lastUpdate" value="STRING" />
        <entry key="lastUpdateDetail" value="STRING" />
        <entry key="ou" value="LIST" />
        <entry key="seeAlso" value="STRING" />
        <entry key="info" value="STRING" />
      </map>
    </constructor-arg>
    <constructor-arg>
      <map>
        <entry key="dn" value="location" />
        <entry key="displayName" value="displayName" />
        <entry key="o" value="company" />
        <entry key="cn" value="fullName" />
        <entry key="uid" value="userName" />
        <entry key="status" value="status" />
        <entry key="mail" value="mail" />
        <entry key="description" value="description" />
        <entry key="sn" value="surname" />
        <entry key="givenName" value="firstName" />
        <entry key="telephoneNumber" value="phoneNumber.number" />
        <entry key="mobile" value="mobileNumber.number" />
        <entry key="jpegPhoto" value="photo" />
        <entry key="jobTitle" value="jobTitle" />
        <entry key="ou" value="qualifers" />
        <entry key="department" value="department" />
        <entry key="lastUpdate" value="lastUpdate" />
        <entry key="lastUpdateDetail" value="lastUpdateDetail" />
        <entry key="seeAlso" value="companyLocation" />
        <entry key="info" value="notes" />
      </map>
    </constructor-arg>
  </bean>

  <bean id="PersonFilter" class="com.zuooh.ldap.record.TokenFilter">
    <constructor-arg>
      <list>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="LIST" />
          <constructor-arg value="objectClass" />
          <constructor-arg value="person" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="LIST" />
          <constructor-arg value="objectClass" />
          <constructor-arg value="organizationalPerson" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="LIST" />
          <constructor-arg value="objectClass" />
          <constructor-arg value="inetOrgPerson" />
        </bean>
      </list>
    </constructor-arg>
  </bean>

  <bean id="PersonConverter" class="com.zuooh.ldap.record.TokenConverter">
    <constructor-arg ref="PersonMapper" />
    <constructor-arg ref="PersonFilter" />
    <constructor-arg value="com.zuooh.ldap.model.Person" />
  </bean>

  <bean id="PersonBuilder" class="com.zuooh.ldap.record.TemplateBuilder">
    <qualifier value="person" />
    <constructor-arg>
      <list>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="STRING" />
          <constructor-arg value="cn" />
          <constructor-arg value="%{firstName} %{surname}" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="STRING" />
          <constructor-arg value="co" />
          <constructor-arg value="Australia" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="STRING" />
          <constructor-arg value="o" />
          <constructor-arg value="%{company}" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="STRING" />
          <constructor-arg value="company" />
          <constructor-arg value="o=%{company},ou=Companies,dc=zuooh,dc=com" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="STRING" />
          <constructor-arg value="displayName" />
          <constructor-arg value="%{firstName} %{surname} - %{company}" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="STRING" />
          <constructor-arg value="expireDate" />
          <constructor-arg value="1" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="STRING" />
          <constructor-arg value="givenName" />
          <constructor-arg value="%{firstName}" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="STRING" />
          <constructor-arg value="mail" />
          <constructor-arg value="%{mail}" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="STRING" />
          <constructor-arg value="mailNickname" />
          <constructor-arg value="%{userName}" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="STRING" />
          <constructor-arg value="userPassword" />
          <constructor-arg value="%{password}" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="STRING" />
          <constructor-arg value="sn" />
          <constructor-arg value="%{surname}" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="STRING" />
          <constructor-arg value="status" />
          <constructor-arg value="1" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="STRING" />
          <constructor-arg value="uid" />
          <constructor-arg value="%{userName}" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="STRING" />
          <constructor-arg value="description" />
          <constructor-arg value="%{description}" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="STRING" />
          <constructor-arg value="telephoneNumber" />
          <constructor-arg value="%{phoneNumber}" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="STRING" />
          <constructor-arg value="mobile" />
          <constructor-arg value="%{mobileNumber}" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="STRING" />
          <constructor-arg value="jobTitle" />
          <constructor-arg value="%{jobTitle}" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="STRING" />
          <constructor-arg value="department" />
          <constructor-arg value="%{department}" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="STRING" />
          <constructor-arg value="info" />
          <constructor-arg value="%{notes}" />
        </bean>
      </list>
    </constructor-arg>
    <constructor-arg>
      <list>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="LIST" />
          <constructor-arg value="objectClass" />
          <constructor-arg value="person" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="LIST" />
          <constructor-arg value="objectClass" />
          <constructor-arg value="organizationalPerson" />
        </bean>
        <bean class="com.zuooh.ldap.record.Token">
          <constructor-arg value="LIST" />
          <constructor-arg value="objectClass" />
          <constructor-arg value="inetOrgPerson" />
        </bean>
      </list>
    </constructor-arg>
    <constructor-arg value="mail=%{mail},ou=Users,dc=zuooh,dc=com" />
  </bean>

  <bean id="PersonAttributeValidator" class="com.zuooh.ldap.record.validate.TokenRecordValidator">
    <constructor-arg>
      <list>
        <bean class="com.zuooh.ldap.record.validate.TokenValidator">
          <constructor-arg value="mail" />
          <constructor-arg value=".*@.*" />
          <constructor-arg value="Person mail address '%{mail}' is not valid" />
          <constructor-arg value="Person must have a mail address" />
        </bean>
        <bean class="com.zuooh.ldap.record.validate.TokenValidator">
          <constructor-arg value="cn" />
          <constructor-arg value=".*[a-zA-Z]+.*" />
          <constructor-arg value="Person name '%{cn}' is not valid" />
          <constructor-arg value="Person must have a name" />
        </bean>
        <bean class="com.zuooh.ldap.record.validate.TokenValidator">
          <constructor-arg value="department" />
          <constructor-arg value=".*[a-zA-Z]+.*" />
          <constructor-arg value="Person department '%{department}' is not valid" />
        </bean>
        <bean class="com.zuooh.ldap.record.validate.TokenValidator">
          <constructor-arg value="mobile" />
          <constructor-arg value="[0-9\(\) -\+]+" />
          <constructor-arg value="Person mobile number '%{mobile}' is not valid" />
        </bean>
        <bean class="com.zuooh.ldap.record.validate.TokenValidator">
          <constructor-arg value="telephoneNumber" />
          <constructor-arg value="[0-9\(\) -\+]+" />
          <constructor-arg value="Person phone number '%{telephoneNumber}' is not valid" />
        </bean>
        <bean class="com.zuooh.ldap.record.validate.TokenValidator">
          <constructor-arg value="info" />
          <constructor-arg value=".*[a-zA-Z]+.*" />
          <constructor-arg value="Person notes '%{info}' is not valid" />
        </bean>
        <bean class="com.zuooh.ldap.record.validate.TokenValidator">
          <constructor-arg value="o" />
          <constructor-arg value="[a-zA-Z]+" />
          <constructor-arg value="Company '%{o}' is not valid" />
          <constructor-arg value="Person must have a valid company" />
        </bean>
        <bean class="com.zuooh.ldap.record.validate.TokenValidator">
          <constructor-arg value="company" />
          <constructor-arg value="o=([a-zA-Z]+),ou=Companies,dc=zuooh,dc=com" />
          <constructor-arg value="Company location '%{company}' is not valid" />
          <constructor-arg value="Person must reference a valid company" />
        </bean>
      </list>
    </constructor-arg>
  </bean>

  <bean id="PersonLocationValidator" class="com.zuooh.ldap.record.validate.LocationRecordValidator">
    <constructor-arg value="mail=(.*),ou=Users,dc=zuooh,dc=com" />
    <constructor-arg value="Person location did not match 'mail=(.*),ou=Users,dc=zuooh,dc=com'" />
  </bean>

  <bean id="PersonCompanyValidator" class="com.zuooh.ldap.record.validate.ReferenceRecordValidator">
    <constructor-arg ref="Directory" />
    <constructor-arg value="company" />
    <constructor-arg value="Person references company '%{company}' which could not be found" />
  </bean>

  <bean id="PersonValidator" class="com.zuooh.ldap.record.validate.CombinationRecordValidator">
    <constructor-arg>
      <list>
        <ref bean="PersonAttributeValidator" />
        <ref bean="PersonLocationValidator" />
        <ref bean="PersonCompanyValidator" />
      </list>
    </constructor-arg>
  </bean>

  <bean id="PasswordMailTemplate" class="com.zuooh.ldap.model.mail.FileMailTemplate">
    <constructor-arg value="Yieldbroker Password Notification" />
    <constructor-arg value="template/directory/mail/template/password.txt" />
    <constructor-arg value="UTF-8" />
  </bean>
  
  <bean id="PasswordMailMessage" class="com.zuooh.common.mail.MailMessage">
    <constructor-arg value="TEXT" />
    <constructor-arg>
      <bean class="com.zuooh.common.mail.MailAddress">
        <constructor-arg value="helpdesk@zuooh.com" />
      </bean>
    </constructor-arg>
    <constructor-arg>
      <set>
        <bean class="com.zuooh.common.mail.MailRecipient">
          <constructor-arg value="BCC" />
          <constructor-arg value="niall.gallagher@zuooh.com" />
        </bean>       
      </set>
    </constructor-arg>       
    <constructor-arg value="Yieldbroker Password Notification" />
    <constructor-arg value="" /> 
  </bean>

  <bean id="PasswordMailSender" class="com.zuooh.ldap.model.password.PasswordMailSender">
    <constructor-arg ref="ModelContainer" />
    <constructor-arg ref="MailClient" />
    <constructor-arg ref="PasswordMailMessage" />
    <constructor-arg ref="PasswordMailTemplate" />
  </bean>

  <bean id="PasswordUpdater" class="com.zuooh.ldap.model.password.PasswordUpdater">
    <constructor-arg ref="DirectoryContext" />
    <constructor-arg ref="PasswordMailSender" />
    <constructor-arg value="mail" />
    <constructor-arg value="userPassword" />
  </bean>

  <bean id="PersonDeletePersister" class="com.zuooh.ldap.model.persist.PersonDeletePersister">
    <constructor-arg ref="Directory" />
    <constructor-arg ref="ModelContainer" />
    <constructor-arg ref="LocationManager" />
  </bean>

  <bean id="PersonInsertPersister" class="com.zuooh.ldap.model.persist.PersonInsertPersister">
    <constructor-arg ref="Directory" />
    <constructor-arg ref="ModelContainer" />
    <constructor-arg ref="PasswordUpdater" />
    <constructor-arg ref="RecordBinder" />
  </bean>

  <bean id="PersonUpdatePersister" class="com.zuooh.ldap.model.persist.PersonUpdatePersister">
    <constructor-arg ref="Directory" />
    <constructor-arg ref="ModelContainer" />
    <constructor-arg ref="PasswordUpdater" />
    <constructor-arg ref="RecordBinder" />
    <constructor-arg value="mail" />
  </bean>

  <bean id="PersonPersister" class="com.zuooh.ldap.record.persist.RecordPersister">
    <qualifier value="person" />
    <constructor-arg>
      <bean class="com.zuooh.ldap.record.persist.InsertRecordOperation">
        <constructor-arg ref="PersonInsertPersister" />
        <constructor-arg ref="PersonBuilder" />
        <constructor-arg ref="PersonValidator" />
        <constructor-arg value="Could not insert person" />
      </bean>
    </constructor-arg>
    <constructor-arg>
      <bean class="com.zuooh.ldap.record.persist.UpdateRecordOperation">
        <constructor-arg ref="PersonUpdatePersister" />
        <constructor-arg ref="PersonBuilder" />
        <constructor-arg ref="PersonValidator" />
        <constructor-arg value="Could not update person" />
      </bean>
    </constructor-arg>
    <constructor-arg>
      <bean class="com.zuooh.ldap.record.persist.DeleteRecordOperation">
        <constructor-arg ref="PersonDeletePersister" />
        <constructor-arg ref="PersonBuilder" />
        <constructor-arg value="Could not delete person" />
      </bean>
    </constructor-arg>
  </bean>

  <bean id="RecordBinder" class="com.zuooh.ldap.record.RecordBinder">
    <constructor-arg>
      <list>
        <ref bean="PersonConverter" />
        <ref bean="PersonListConverter" />
        <ref bean="CompanyConverter" />
        <ref bean="GroupConverter" />
      </list>
    </constructor-arg>
  </bean>

  <bean id="Directory" class="com.zuooh.ldap.record.DirectoryBinder">
    <qualifier value="external" />
    <constructor-arg ref="DirectoryContext" />
    <constructor-arg ref="RecordBinder" />
    <constructor-arg value="dn" />
  </bean>

  <bean id="PersonContainer" class="com.zuooh.ldap.model.PersonManager">
    <constructor-arg ref="Directory" />
    <constructor-arg>
      <bean class="com.zuooh.ldap.search.And">
        <constructor-arg>
          <list>
            <bean class="com.zuooh.ldap.search.TermQuery">
              <constructor-arg value="objectClass" />
              <constructor-arg value="inetOrgPerson" />
            </bean>
            <bean class="com.zuooh.ldap.search.TermQuery">
              <constructor-arg value="objectClass" />
              <constructor-arg value="organizationalPerson" />
            </bean>
            <bean class="com.zuooh.ldap.search.TermQuery">
              <constructor-arg value="objectClass" />
              <constructor-arg value="person" />
            </bean>
          </list>
        </constructor-arg>
      </bean>
    </constructor-arg>
  </bean>

  <bean id="GroupContainer" class="com.zuooh.ldap.model.GroupManager">
    <constructor-arg ref="Directory" />
    <constructor-arg ref="PersonContainer" />
    <constructor-arg>
      <bean class="com.zuooh.ldap.search.And">
        <constructor-arg>
          <list>
            <bean class="com.zuooh.ldap.search.TermQuery">
              <constructor-arg value="objectClass" />
              <constructor-arg value="groupOfUniqueNames" />
            </bean>
          </list>
        </constructor-arg>
      </bean>
    </constructor-arg>
  </bean>

  <bean id="CompanyContainer" class="com.zuooh.ldap.model.CompanyManager">
    <constructor-arg ref="Directory" />
    <constructor-arg ref="PersonContainer" />
    <constructor-arg>
      <bean class="com.zuooh.ldap.search.TermQuery">
        <constructor-arg value="objectClass" />
        <constructor-arg value="organization" />
      </bean>
    </constructor-arg>
  </bean>

  <bean id="ModelContainer" class="com.zuooh.ldap.model.ModelContainer">
    <constructor-arg ref="PersonContainer" />
    <constructor-arg ref="CompanyContainer" />
    <constructor-arg ref="GroupContainer" />
  </bean>

  <bean id="LocationManager" class="com.zuooh.ldap.record.LocationManager">
    <constructor-arg>
      <map>
        <entry key="mail=(.*),ou=Users,dc=zuooh,dc=com" value="mail=%{1},ou=Deleted,dc=zuooh,dc=com" />
        <entry key="o=(.*),ou=Companies,dc=zuooh,dc=com" value="o=%{1},ou=Deleted,dc=zuooh,dc=com" />
        <entry key="cn=(.*),ou=Groups,dc=zuooh,dc=com" value="cn=%{1},ou=Deleted,dc=zuooh,dc=com" />
      </map>
    </constructor-arg>
  </bean>
  
  <bean id="IdentityResolver" class="com.zuooh.http.sso.client.IdentityResolver">
    <constructor-arg ref="PersonContainer" />
    <constructor-arg>
      <list>
        <value>${sso.primaryServer}</value>
        <value>${sso.secondaryServer}</value>
      </list>
    </constructor-arg>
    <constructor-arg value="SSOID" />
  </bean>  

</beans>
